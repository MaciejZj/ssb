#!/bin/sh

function usage
{
	echo \
		"Usage: $0 [-d|-g|-h|-r] [-c CSS_PATH] [-e HEADER_PATH]" \
		"[-f FOOTER_PATH] [-m MARKDOWN_RENDERER] [-o OUTPUT_DIR] [-p POSTS_DIR]"
	exit 0
}


function parse_optargs
{
	while getopts "dghrc:e:f:m:o:p:" opt; do
		case $opt in
			d)
				DISABLE_POSTS=true;;
			g)
				gen_template;;
			h)
				usage;;
			r)
				RECURSE_POSTS=true;;
			c)
				CSS_PATH=$OPTARG;;
			e)
				HEADER_PATH=$OPTARG;;
			f)
				FOOTER_PATH=$OPTARG;;
			m)
				MARKDOWN_RENDERER=$OPTARG;;
			o)
				OUTPUT_DIR=$OPTARG;;
			p)
				POSTS_DIR=$OPTARG;;
		esac
	done
}


function set_default_args
{
	CSS_PATH=./styles.css
	FOOTER_PATH=./footer.html
	HEADER_PATH=./header.html
	MARKDOWN_RENDERER=pandoc
	OUTPUT_DIR=./
	POSTS_DIR=./posts
}

function echo_header_template
{
	echo \
'<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">

    <title>Title</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<header>
<nav>
    <strong>Title</strong>&nbsp;
    <a href="./index.html">home</a>&nbsp;
    -&nbsp;
    <a href="">media</a>&nbsp;
    <a href="mailto:">email</a>
</nav>
</header>
'
}


function echo_footer_template
{
	echo \
'<footer>
</footer>
</body>
</html>'
}	


function gen_template
{
	echo_header_template > ./header.html
	echo_footer_template > ./footer.html
}


function get_posts
{
	if [ "$RECURSE_POSTS" = false ]; then
		DEPTH_LIMITER="-maxdepth 1"
	fi
	
	find $POSTS_DIR $DEPTH_LIMITER -type f -name "*.md"
}

set_default_args
parse_optargs $@
shift `expr $OPTIND - 1`
pages="$@"
posts=`get_posts`

md_files="$pages $posts"

for md_file in $md_files; do
    file_base=`basename $md_file .md`
    $MARKDOWN_RENDERER $md_file > $file_base.html
    cat $HEADER_PATH $file_base.html $FOOTER_PATH | tee $file_base.html
done
